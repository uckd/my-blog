# AGENTS.md

このドキュメントは、このリポジトリで作業する AI エージェント向けの**必須ルール**です。
**ユーザーの直接指示**がこのドキュメントと矛盾する場合は、**ユーザー指示を優先**します。

---

## 0. 指示の適用範囲と優先順位（重要）

- 作業前に `AGENTS.md` / `AGENTS.override.md` を探索し、**ルート → 現在ディレクトリ**の順に結合します。
- 同一ディレクトリに `AGENTS.override.md` がある場合、通常 `AGENTS.md` より優先されます。
- **より近いディレクトリの指示ほど優先**されます（後に結合されるため）。
- 指示チェーンにはサイズ上限があります。長文化する場合は、必要に応じてディレクトリ配下へ分割して配置してください。

---

## 1. コア原則（Safety / Minimal Change）

- 変更は常に **最小・安全・巻き戻し容易** にする。
- 既存のアーキテクチャ、挙動、意図を **維持** する。
- 依頼されたタスクと無関係なリファクタ・リネーム・整形・クリーンアップは **しない**。
- 変更前に「現状の挙動」と「意図」を把握する。
- 変更後は **依頼された挙動だけ** が変わることを確認する。

---

## 2. 設計と実装の優先順位（Clarity > Cleverness）

- **明確さ > 賢さ**
- **単純さ > 複雑さ**
- 長期保守性を損なわない範囲で、必要最小限の抽象化のみ行う。

---

## 3. 進め方（作業フロー）

### 3.1 変更前

- まず既存コード・設定・ドキュメントから仕様を読み取る（推測で補完しない）。
- 依頼内容が曖昧なら、実装に入る前に **質問** して不確実性を解消する。

### 3.2 変更中

- 触る範囲は最小にし、差分が読みやすい形でコミット（または提案）する。
- 既存パターン（例外処理、ログ、エラーハンドリング、命名、責務分割）に従う。

### 3.3 変更後

- リポジトリの標準コマンドで、最低限の検証（テスト/静的解析）を実施する。
- 変更により壊れた既存テストがある場合は、**関連する最小限の修正**で復旧させる（無関係なテスト改変はしない）。

---

## 4. セットアップ / テスト / 品質コマンド（推測しない）

このリポジトリ固有のコマンドが明記されていない場合、次の順で **実在するコマンドのみ** を特定して実行すること：

1. `README.md` / `CONTRIBUTING.md` / `Makefile`
2. 言語別の標準設定ファイル（例：`package.json`, `composer.json`, `pyproject.toml`, `go.mod`, `Cargo.toml` など）
3. CI 定義（例：`.github/workflows/*`）に書かれたコマンド

見つかった標準コマンドに従い、可能な範囲で以下を実行する：

- テスト（unit/integration など）
- lint / typecheck（存在する場合）
- build（存在する場合）

> 注意: コマンドが不明・実行不能な場合は、勝手に代替案で“通ったことにする”のではなく、状況と根拠を説明してユーザーに確認する。

---

## 5. 依存関係（Dependencies）

- **新規依存の追加は禁止**（絶対に必要な場合を除く）。
- 追加が不可避な場合：
  - 追加理由（なぜ必要か）を明確に説明する
  - 標準ライブラリや既存依存では不十分な理由を説明する
  - 影響範囲（ビルド、サイズ、セキュリティ、運用）を簡潔に記述する
- 不要になった依存は削除し、関連設定も整合させる。

---

## 6. 言語（Language）

- エージェントの説明、提案、レポートは **日本語** で書く。
- コード内の識別子・コメント言語は **既存の慣習に合わせる**（コードベースが英語なら英語を維持）。

---

## 7. コメント（Comments）

- **メソッド/関数レベル**で追加・大幅変更を行った場合、適切なコメントを追加する。
- コメントは「何をしているか」ではなく、主に **なぜそれが必要か（前提・制約・注意点）** を書く。
- 自明な処理を繰り返す冗長コメントは避ける。

---

## 8. テスト（Testing）

- ユーザーが明示的に求めない限り、無関係なテスト改変や大規模なテスト整理はしない。
- ただし、**自分の変更が原因で既存テストが失敗する場合**は、関連する最小限の修正でテストを復旧してよい。
- バグ修正や分岐追加など、挙動に影響する変更では **最小限のテスト追加/更新**を検討する。

---

## 9. レビュー観点（Review guidelines）

変更のレビューでは、少なくとも以下を確認する：

- 機密情報（APIキー、トークン、パスワード等）や PII を **ログ/レスポンス/例外**に出さない
- 外部入力（HTTP、CLI、Webhook、Queue 等）に対して **バリデーション/サニタイズ**がある
- 認証・認可が必要な経路で **認可漏れ**がない（ミドルウェア、ガード、ポリシー）
- エラーハンドリングが既存方針と整合し、破壊的変更がない
- 互換性（設定・マイグレーション・API）に配慮し、ロールバック可能性が高い

---

## 10. ファイルサイズと責務（Single Responsibility）

- 目安として、1ファイルは **300行以下**（コメント/空行含む）を推奨する。
- ただし **最小変更の原則を優先**する：
  - 今回のタスクに直接関係しない分割・移動は行わない
  - 分割が必要な場合でも、公開 API や import 境界を壊さず、差分最小で行う
- モジュールは単一責務を守り、無関係な関心ごとを混在させない。

---

## 11. 不確実性（Assumptions and Uncertainty）

- 仕様・要件・期待挙動が不明なまま **推測で実装しない**。
- 不明点は、実装前に **確認質問**を行う（必要なら選択肢を提示）。

---

## 12. 大きな変更の扱い

- 複数モジュールにまたがる変更や、設計判断を伴う変更では、実装前に **短い作業計画**（目的/方針/影響/検証）を提示して合意を取る。
- ユーザーから求められた場合は、別途 `PLANS.md` 等に実行計画をまとめてもよい（ただし増分は最小に）。
